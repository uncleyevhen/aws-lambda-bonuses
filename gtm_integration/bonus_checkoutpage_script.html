<style>
#bonus-block .j-bonus-add-mobile {
    color: green;
    font-weight: bold;
}
</style>
<script>
(function(){
  'use strict';

  // –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
  var DEBUG_MODE = true;
  var LOG_PREFIX = '[BONUS_SCRIPT]';

  function log(message, data) {
    if (DEBUG_MODE) {
      var timestamp = new Date().toISOString();
      if (data) {
        console.log(LOG_PREFIX + ' [' + timestamp + '] ' + message, data);
      } else {
        console.log(LOG_PREFIX + ' [' + timestamp + '] ' + message);
      }
    }
  }

  function logError(message, error) {
    var timestamp = new Date().toISOString();
    if (error) {
      console.error(LOG_PREFIX + ' [' + timestamp + '] ERROR: ' + message, error);
    } else {
      console.error(LOG_PREFIX + ' [' + timestamp + '] ERROR: ' + message);
    }
  }

  var KEYCRM_PROXY_URL = "https://ahbuukd5gtpnnjt7575zlxb4pu0ilfpu.lambda-url.eu-north-1.on.aws/";
  var PROMO_API_URL = "https://k3pok2o5t1.execute-api.eu-north-1.amazonaws.com";
  var CERTIFICATE_SELECTORS = ['.cart-discount-info', '.coupon__name', '.order-details__cost-name', '.order-details-h'];
  var PHONE_SELECTORS = ['.j-phone-masked', 'input[type="tel"]', 'input[name*="phone"]'];

  log('–°–∫—Ä–∏–ø—Ç —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ', {
    url: window.location.href,
    userAgent: navigator.userAgent,
    timestamp: new Date().toISOString()
  });

  var bonusState = {
    promoApplied: false,
    promoType: null,
    currentPhone: "",
    phoneValidated: false,
    balance: 0,
    isCheckingBalance: false,
    blockVisible: false,
    formVisible: false,
    inputValue: "",
    blockRemovedIntentionally: false,
    currentPageUrl: window.location.href,
    textReplaced: false
  };

  function updateBonusState(updates) {
    log('–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –±–æ–Ω—É—Å—ñ–≤', { old: bonusState, updates: updates });
    Object.assign(bonusState, updates);
    saveBonusState();
  }

  function resetBonusState() {
    log('–°–∫–∏–¥–∞–Ω–Ω—è —Å—Ç–∞–Ω—É –±–æ–Ω—É—Å—ñ–≤', { currentState: bonusState });
    var currentPhone = bonusState.currentPhone;
    bonusState.promoApplied = false;
    bonusState.promoType = null;
    bonusState.currentPhone = "";
    bonusState.phoneValidated = false;
    bonusState.balance = 0;
    bonusState.isCheckingBalance = false;
    bonusState.blockVisible = false;
    bonusState.formVisible = false;
    bonusState.inputValue = "";
    bonusState.blockRemovedIntentionally = false;
    saveBonusState();
    bonusState.currentPhone = currentPhone;
    log('–°—Ç–∞–Ω –±–æ–Ω—É—Å—ñ–≤ —Å–∫–∏–Ω—É—Ç–æ', { newState: bonusState });
  }

  function saveBonusState() {
    try {
      localStorage.setItem('bonusState', JSON.stringify(bonusState));
      log('–°—Ç–∞–Ω –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ localStorage', bonusState);
    } catch(e) {
      logError('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –≤ localStorage', e);
    }
  }

  function loadBonusState() {
    try {
      var savedState = localStorage.getItem('bonusState');
      if (savedState) {
        var parsedState = JSON.parse(savedState);
        delete parsedState.currentPageUrl;
        Object.assign(bonusState, parsedState);
        log('–°—Ç–∞–Ω –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∑ localStorage', bonusState);
      } else {
        log('–ó–±–µ—Ä–µ–∂–µ–Ω–∏–π —Å—Ç–∞–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ localStorage');
      }
    } catch (e) {
      logError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –∑ localStorage', e);
    }
  }

  function debounce(func, wait) {
    var timeout;
    return function() {
      var context = this, args = arguments;
      clearTimeout(timeout);
      timeout = setTimeout(function() {
        func.apply(context, args);
      }, wait);
    };
  }

  function waitForElement(selector, timeout) {
    timeout = timeout || 5000;
    log('–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç–∞: ' + selector + ' (timeout: ' + timeout + 'ms)');
    return new Promise(function(resolve, reject) {
      var element = document.querySelector(selector);
      if (element) {
        log('–ï–ª–µ–º–µ–Ω—Ç –∑–Ω–∞–π–¥–µ–Ω–æ –≤—ñ–¥—Ä–∞–∑—É: ' + selector, element);
        resolve(element);
        return;
      }
      var observer = new MutationObserver(function() {
        var element = document.querySelector(selector);
        if (element) {
          log('–ï–ª–µ–º–µ–Ω—Ç –∑–Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–µ–∑ observer: ' + selector, element);
          observer.disconnect();
          resolve(element);
        }
      });
      observer.observe(document.body, { childList: true, subtree: true });
      setTimeout(function() {
        observer.disconnect();
        var el = document.querySelector(selector);
        if (el) {
          log('–ï–ª–µ–º–µ–Ω—Ç –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –∫—ñ–Ω—Ü—ñ timeout: ' + selector, el);
          resolve(el);
        } else {
          logError('–ï–ª–µ–º–µ–Ω—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—ñ—Å–ª—è timeout: ' + selector);
          reject(new Error('Element ' + selector + ' not found'));
        }
      }, timeout);
    });
  }

  function waitForElementWithCondition(selector, condition, timeout) {
    timeout = timeout || 5000;
    return new Promise(function(resolve, reject) {
      function checkElement() {
        var elements = document.querySelectorAll(selector);
        for (var i = 0; i < elements.length; i++) {
          if (condition(elements[i])) {
            resolve(elements[i]);
            return true;
          }
        }
        return false;
      }
      if (checkElement()) return;
      var observer = new MutationObserver(function() {
        if (checkElement()) observer.disconnect();
      });
      observer.observe(document.body, { childList: true, subtree: true });
      setTimeout(function() {
        observer.disconnect();
        reject(new Error('Element with condition not found'));
      }, timeout);
    });
  }

  function replaceTextInElement(element, oldText, newText) {
    if (!element) return false;
    var walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
    var textNodes = [];
    var node;
    while (node = walker.nextNode()) {
      if (node.nodeValue.includes(oldText)) {
        textNodes.push(node);
      }
    }
    var replaced = false;
    textNodes.forEach(function(textNode) {
      textNode.nodeValue = textNode.nodeValue.replace(new RegExp(oldText, 'g'), newText);
      replaced = true;
    });
    return replaced;
  }

  function instantTextReplace() {
    log('–°–ø—Ä–æ–±–∞ –º–∏—Ç—Ç—î–≤–æ—ó –∑–∞–º—ñ–Ω–∏ —Ç–µ–∫—Å—Ç—É');
    var replaced = false;
    CERTIFICATE_SELECTORS.forEach(function(selector) {
      var elements = document.querySelectorAll(selector);
      log('–ó–Ω–∞–π–¥–µ–Ω–æ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ ' + selector + ':', elements.length);
      elements.forEach(function(el) {
        if (el.textContent && el.textContent.includes('–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç') && !el.closest('#bonus-block')) {
          log('–ó–∞–º—ñ–Ω–∞ —Ç–µ–∫—Å—Ç—É –≤ –µ–ª–µ–º–µ–Ω—Ç—ñ', { element: el, oldText: el.textContent });
          if (replaceTextInElement(el, '–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç', '–ë–æ–Ω—É—Å–∏')) {
            replaced = true;
            log('–¢–µ–∫—Å—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞–º—ñ–Ω–µ–Ω–æ', { element: el, newText: el.textContent });
          }
        }
      });
    });
    log('–†–µ–∑—É–ª—å—Ç–∞—Ç –º–∏—Ç—Ç—î–≤–æ—ó –∑–∞–º—ñ–Ω–∏ —Ç–µ–∫—Å—Ç—É:', replaced);
    return replaced;
  }

  function isPromoCodeApplied() {
    var removeButton = document.querySelector('.j-coupon-remove');
    log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ø—Ä–æ–º–æ–∫–æ–¥—É', { removeButton: removeButton });
    if (!removeButton) {
        log('–ö–Ω–æ–ø–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø—Ä–æ–º–æ–∫–æ–¥—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
        return false;
    }
    var style = window.getComputedStyle(removeButton);
    var result = style.display !== 'none' && style.visibility !== 'hidden' && removeButton.offsetWidth > 0 && removeButton.offsetHeight > 0;
    log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥—É:', { 
      result: result, 
      display: style.display, 
      visibility: style.visibility, 
      width: removeButton.offsetWidth, 
      height: removeButton.offsetHeight 
    });
    return result;
  }

  function isBonusPromoCodeApplied() {
    log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –±–æ–Ω—É—Å–Ω–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥—É');
    var promoApplied = isPromoCodeApplied();
    if (!promoApplied) {
        log('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ');
        return false;
    }
    if (bonusState.promoApplied && bonusState.promoType === 'bonus') {
        log('–ë–æ–Ω—É—Å–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –∑–≥—ñ–¥–Ω–æ –∑—ñ —Å—Ç–∞–Ω–æ–º');
        return true;
    }
    var certificateElements = document.querySelectorAll(CERTIFICATE_SELECTORS.join(','));
    log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É:', certificateElements.length);
    for (var i = 0; i < certificateElements.length; i++) {
      var el = certificateElements[i];
      if (el.textContent && el.textContent.includes('–ë–æ–Ω—É—Å–∏') && !el.closest('#bonus-block')) {
        log('–ó–Ω–∞–π–¥–µ–Ω–æ –µ–ª–µ–º–µ–Ω—Ç –∑ —Ç–µ–∫—Å—Ç–æ–º "–ë–æ–Ω—É—Å–∏"', el);
        return true;
      }
    }
    log('–ë–æ–Ω—É—Å–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ');
    return false;
  }

  function isRegularPromoCodeApplied() {
    return isPromoCodeApplied() && !isBonusPromoCodeApplied();
  }

  function ensurePhoneLockState() {
    log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —Ç–µ–ª–µ—Ñ–æ–Ω—É');
    var isBonus = isBonusPromoCodeApplied();
    log('–ë–æ–Ω—É—Å–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ:', isBonus);
    if (isBonus) {
      disablePhoneInput();
    } else {
      enablePhoneInput();
    }
  }

  function disablePhoneInput() {
    log('–ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—É');
    var phoneInput = findPhoneInput();
    if (phoneInput) {
        if (!phoneInput.disabled) {
            phoneInput.disabled = true;
            log('–ü–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ', phoneInput);
        } else {
            log('–ü–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É –≤–∂–µ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ');
        }
    } else {
        log('–ü–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è');
    }
  }

  function enablePhoneInput() {
    log('–†–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—É');
    var phoneInput = findPhoneInput();
    if (phoneInput) {
        if (phoneInput.disabled) {
            phoneInput.disabled = false;
            log('–ü–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ', phoneInput);
        } else {
            log('–ü–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É –≤–∂–µ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ');
        }
    } else {
        log('–ü–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–ª—è —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è');
    }
  }

  function checkBonusPromoWithRetry(maxAttempts, delay) {
    function attemptCheck(attempt) {
      if (isBonusPromoCodeApplied()) {
        instantTextReplace();
        ensurePhoneLockState();
        return;
      }
      if (attempt < maxAttempts) {
        setTimeout(function() { attemptCheck(attempt + 1); }, delay);
      }
    }
    attemptCheck(1);
  }

  function waitForPromoCodeRemoval(timeout) {
    timeout = timeout || 5000;
    return new Promise(function(resolve) {
      var interval = 100;
      var elapsedTime = 0;
      function check() {
        if (!isPromoCodeApplied()) {
          resolve();
        } else {
          elapsedTime += interval;
          if (elapsedTime < timeout) {
            setTimeout(check, interval);
          } else {
            resolve();
          }
        }
      }
      check();
    });
  }

  function removeAppliedPromoCode() {
    var removeButton = document.querySelector('.j-coupon-remove');
    if (removeButton && isPromoCodeApplied()) {
      removeButton.click();
      return waitForPromoCodeRemoval().then(function() {
        showPromoCode();
        return Promise.resolve();
      });
    }
    return Promise.resolve();
  }

  function setupPromoCodeRemovalListener() {
    waitForElement('.j-coupon-remove', 5000).then(function(removeButton) {
      if (removeButton.hasAttribute('data-bonus-listener')) return;
      removeButton.setAttribute('data-bonus-listener', 'true');
      removeButton.addEventListener('click', function() {
        var wasBonusPromo = isBonusPromoCodeApplied();
        waitForPromoCodeRemoval().then(function() {
          if (wasBonusPromo) {
            enablePhoneInput();
            resetBonusState();
            initializeCheckoutPage();
          }
        });
      });
    }).catch(function() {
    });
  }

  function hidePromoCode() {
    var block = document.querySelector('.order-details__block--discount:not(#bonus-block)') || document.querySelector('.order-details-i:not(#bonus-block)');
    if (block) {
      block.style.display = 'none';
      block.style.visibility = 'hidden';
    }
  }

  function showPromoCode() {
    var block = document.querySelector('.order-details__block--discount:not(#bonus-block)') || document.querySelector('.order-details-i:not(#bonus-block)');
    if (block) {
      block.style.display = '';
      block.style.visibility = '';
    }
  }

  function isMobileDevice() {
    return !!document.querySelector('.order-details__block--discount') || !!document.querySelector('.order-details__cost') || window.innerWidth <= 768;
  }

  function findBonusInsertContainer() {
    var containers = [
      { el: document.querySelector('.order-details__block--discount:not(#bonus-block)'), type: 'mobile' },
      { el: document.querySelector('.order-details__cost'), type: 'mobile', insertMode: 'before' },
      { el: document.querySelector('.order-details-i:not(#bonus-block)'), type: 'desktop' },
      { el: document.querySelector('.order-details'), type: 'fallback', insertMode: 'prepend' }
    ];
    for (var i = 0; i < containers.length; i++) {
      if (containers[i].el) {
        return containers[i];
      }
    }
    return null;
  }

  function getOrderTotal() {
    var totalElement = document.querySelector('.j-total-sum');
    if (totalElement) {
      var text = totalElement.textContent || '';
      var amount = parseFloat(text.replace(/[^\d]/g, ''));
      if (!isNaN(amount) && amount > 0) {
        return amount;
      }
    }
    return 1000;
  }

  function createBonusBlock(container, bonusBalance, insertMode, containerType, showPrompt) {
    if (document.querySelector('#bonus-block') || bonusState.blockRemovedIntentionally) {
      log('–ë–ª–æ–∫ –±–æ–Ω—É—Å—ñ–≤ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ', { 
        exists: !!document.querySelector('#bonus-block'), 
        intentionallyRemoved: bonusState.blockRemovedIntentionally 
      });
      return;
    }
    
    log('–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–ª–æ–∫—É –±–æ–Ω—É—Å—ñ–≤', { 
      container: container, 
      bonusBalance: bonusBalance, 
      insertMode: insertMode, 
      containerType: containerType,
      showPrompt: showPrompt
    });
    
    var isMobile = containerType === 'mobile' || isMobileDevice();
    log('–¢–∏–ø –ø—Ä–∏—Å—Ç—Ä–æ—é:', { isMobile: isMobile, containerType: containerType });
    
    var bonusBlock = document.createElement("div");
    bonusBlock.id = "bonus-block";
    bonusBlock.style.display = 'none';
    if (isMobile) {
      bonusBlock.className = "order-details__block order-details__block--discount";
      bonusBlock.innerHTML = createMobileBonusHTML(bonusBalance, showPrompt);
    } else {
      bonusBlock.className = "order-details-i";
      bonusBlock.innerHTML = createDesktopBonusHTML(bonusBalance, showPrompt);
    }
    insertBonusBlock(bonusBlock, container, insertMode);
    log('–ë–ª–æ–∫ –±–æ–Ω—É—Å—ñ–≤ —Å—Ç–≤–æ—Ä–µ–Ω–æ —ñ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ');
    
    // –Ø–∫—â–æ –ø–æ–∫–∞–∑—É—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É –ø—Ä–æ –≤–≤–µ–¥–µ–Ω–Ω—è –Ω–æ–º–µ—Ä–∞, –±–ª–æ–∫—É—î–º–æ –≤–∑–∞—î–º–æ–¥—ñ—é
    if (showPrompt) {
      toggleBonusElements(true, '0.5');
    } else {
      attachBonusLogic();
    }
    
    restoreBonusBlockState();
  }

  function restoreBonusBlockState() {
    setTimeout(function() {
      var bonusBlock = document.querySelector('#bonus-block');
      if (!bonusBlock) {
        return;
      }
      var phoneInput = findPhoneInput();
      var shouldShowBlock = phoneInput && isValidPhone(phoneInput.value) && !bonusState.blockRemovedIntentionally;
      updateBonusState({ blockVisible: shouldShowBlock });
      bonusBlock.style.display = shouldShowBlock ? '' : 'none';
      if (shouldShowBlock) {
        var bonusForm = document.querySelector('#bonus-block #bonus-form');
        var bonusLink = document.querySelector('#bonus-block #bonus-link');
        var bonusInput = document.querySelector('#bonus-block #bonus-amount');
        if (bonusState.formVisible && bonusForm && bonusLink) {
          bonusLink.parentElement.style.display = "none";
          bonusForm.style.display = isMobileDevice() ? "flex" : "block";
        }
        if (bonusState.inputValue && bonusInput) {
          bonusInput.value = bonusState.inputValue;
        }
        if (bonusState.balance > 0) {
          updateBonusBlock(bonusState.balance);
        }
        var bonusButton = document.querySelector('#bonus-block #apply-bonus');
        if (bonusButton) {
          bonusButton.disabled = false;
          var btnContent = bonusButton.querySelector('.btn-content') || bonusButton.querySelector('span');
          if (btnContent && btnContent.textContent !== "OK") {
             btnContent.textContent = "OK";
          }
        }
        attachBonusLogic();
      }
    }, 100);
  }

  function createMobileBonusHTML(bonusBalance, showPrompt) {
    var text;
    if (showPrompt) {
      text = 'üéÅ –í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –±–æ–Ω—É—Å—ñ–≤';
    } else {
      text = bonusBalance > 0 ? 'üéÅ –£ –≤–∞—Å —î ' + bonusBalance + ' –±–æ–Ω—É—Å—ñ–≤. –•–æ—á–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏?' : 'üéÅ –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –±–æ–Ω—É—Å–∏...';
    }
    return '<div class="coupon bonus-coupon"><div class="coupon__toggle j-bonus-add-container bonus-add-container"><button class="btn btn--small btn--clear btn--block j-bonus-add-mobile bonus-add-mobile" id="bonus-link" data-bonus-button="true"><span class="btn__icon"><svg class="icon"><use xlink:href="#icon-coupon"></use></svg></span><span class="btn__text" id="bonus-link-text">' + text + '</span></button></div><div class="form-item form-item--toolbar j-bonus-add-form bonus-add-form" id="bonus-form" style="display: none;" data-bonus-form="true"><div class="form-item__content"><input class="input input--small input--clear j-bonus-input bonus-input" id="bonus-amount" type="number" placeholder="–°—É–º–∞ –±–æ–Ω—É—Å—ñ–≤" min="1" max="' + (bonusBalance || 1) + '" data-bonus-input="true"></div><div class="form-item__clear"><button class="btn btn--small btn--clear btn--icon j-bonus-cancel bonus-cancel" id="bonus-cancel" data-bonus-button="true"><span class="btn__icon"><svg class="icon icon--size-s"><use xlink:href="#icon-cross"></use></svg></span></button></div><div class="form-item__button"><button class="btn btn--small btn--primary j-bonus-submit bonus-submit" id="apply-bonus" data-bonus-button="true">OK</button></div><div id="bonus-error" style="color: #e74c3c; font-size: 12px; margin-top: 5px; display: none; width: 100%; flex-basis: 100%;"></div></div></div>';
  }

  function createDesktopBonusHTML(bonusBalance, showPrompt) {
    var text;
    if (showPrompt) {
      text = 'üéÅ –í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –±–æ–Ω—É—Å—ñ–≤';
    } else {
      text = bonusBalance > 0 ? 'üéÅ –£ –≤–∞—Å —î ' + bonusBalance + ' –±–æ–Ω—É—Å—ñ–≤. –•–æ—á–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏?' : 'üéÅ –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –±–æ–Ω—É—Å–∏...';
    }
    return '<div class="order-details-h bonus-details-h"><div class="cart-discount-info j-bonus-add-container bonus-add-container"><a class="link link--pseudo j-bonus-add bonus-add" href="#" id="bonus-link" data-bonus-button="true"><span class="link__text" id="bonus-link-text">' + text + '</span></a></div><div class="cart-discount-coupon j-bonus-add-form bonus-add-form" id="bonus-form" style="display: none;" data-bonus-form="true"><div class="coupon bonus-coupon"><div class="coupon-input"><input class="coupon-field field j-bonus-input bonus-input" id="bonus-amount" placeholder="–°—É–º–∞ –±–æ–Ω—É—Å—ñ–≤" type="number" min="1" max="' + (bonusBalance || 1) + '" data-bonus-input="true"><div class="coupon-cancel j-bonus-cancel bonus-cancel" id="bonus-cancel" data-bonus-button="true"><svg class="icon icon--cross-bold"><use xlink:href="#icon-cross-bold"></use></svg></div></div><div class="coupon-submit"><a class="button add controls_simple btn __small j-bonus-submit bonus-submit" href="#" id="apply-bonus" data-bonus-button="true"><span class="btn-content">OK</span></a></div></div><div id="bonus-error" style="color: #e74c3c; font-size: 12px; margin-top: 5px; display: none;"></div></div></div>';
  }

  function insertBonusBlock(bonusBlock, container, insertMode) {
    switch (insertMode) {
      case 'after': container.parentNode.insertBefore(bonusBlock, container.nextSibling); break;
      case 'before': container.parentNode.insertBefore(bonusBlock, container); break;
      case 'prepend': container.insertBefore(bonusBlock, container.firstChild); break;
      default: container.parentNode.insertBefore(bonusBlock, container.nextSibling);
    }
  }

  function checkBonusBalance(phone) {
    var cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
    log('–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å—É –±–æ–Ω—É—Å—ñ–≤', { phone: phone, cleanPhone: cleanPhone });
    updateBonusState({ isCheckingBalance: true });
    var apiUrl = KEYCRM_PROXY_URL + "?phone=" + encodeURIComponent(phone);
    log('API –∑–∞–ø–∏—Ç –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –±–∞–ª–∞–Ω—Å—É:', apiUrl);
    
    return fetch(apiUrl)
      .then(function(response) { 
        log('–í—ñ–¥–ø–æ–≤—ñ–¥—å API:', { status: response.status, ok: response.ok });
        return response.ok ? response.json() : null; 
      })
      .then(function(data) {
        log('–î–∞–Ω—ñ –≤—ñ–¥ API:', data);
        var balance = (data && data.success && data.bonus_balance !== undefined) ? data.bonus_balance : 0;
        log('–û—Ç—Ä–∏–º–∞–Ω–æ –±–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å—ñ–≤:', balance);
        updateBonusState({ isCheckingBalance: false, balance: balance, currentPhone: cleanPhone, phoneValidated: true });
        return balance;
      })
      .catch(function(error) {
        logError('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å—É –±–æ–Ω—É—Å—ñ–≤', error);
        updateBonusState({ isCheckingBalance: false });
        return 0;
      });
  }

  function findPhoneInput() {
    log('–ü–æ—à—É–∫ –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—É');
    for (var i = 0; i < PHONE_SELECTORS.length; i++) {
      var input = document.querySelector(PHONE_SELECTORS[i]);
      if (input) {
        log('–ó–Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É:', { selector: PHONE_SELECTORS[i], input: input });
        return input;
      }
    }
    log('–ü–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
    return null;
  }

  function showBonusBlock() {
    var bonusBlock = document.querySelector('#bonus-block');
    if (bonusBlock) {
      bonusBlock.style.display = '';
      updateBonusState({ blockVisible: true });
    }
  }

  function hideBonusBlock() {
    var bonusBlock = document.querySelector('#bonus-block');
    if (bonusBlock) {
      bonusBlock.style.display = 'none';
      updateBonusState({ blockVisible: false });
    }
  }

  function showBonusBlockWithLoading() {
    var bonusBlock = document.querySelector('#bonus-block');
    if (bonusBlock) {
      bonusBlock.style.display = '';
      updateBonusState({ blockVisible: true });
      var bonusLinkText = document.querySelector('#bonus-block #bonus-link-text');
      if (bonusLinkText) {
        bonusLinkText.innerText = "üéÅ –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –±–æ–Ω—É—Å–∏...";
      }
    }
  }

  function showBonusBlockWithPrompt() {
    var bonusBlock = document.querySelector('#bonus-block');
    if (bonusBlock) {
      bonusBlock.style.display = '';
      updateBonusState({ blockVisible: true });
      var bonusLinkText = document.querySelector('#bonus-block #bonus-link-text');
      if (bonusLinkText) {
        bonusLinkText.innerText = "üéÅ –í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –±–æ–Ω—É—Å—ñ–≤";
      }
      // –ë–ª–æ–∫—É—î–º–æ –≤–∑–∞—î–º–æ–¥—ñ—é –¥–æ –≤–≤–µ–¥–µ–Ω–Ω—è –Ω–æ–º–µ—Ä–∞
      toggleBonusElements(true, '0.5');
    }
  }

  function isValidPhone(phone) {
    if (!phone) return false;
    var cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
    return phone.indexOf('_') === -1 && cleanPhone.length >= 10;
  }

  function resetBonusStateForNewPhone() {
    resetBonusState();
    var bonusAmount = document.querySelector('#bonus-block #bonus-amount');
    if (bonusAmount) {
      bonusAmount.value = "";
    }
  }

  function handlePhoneChange(telInput, force) {
    force = force || false;
    var phone = telInput.value.trim();
    var cleanPhone = phone.replace(/[\s\-\(\)]/g, '');

    log('–û–±—Ä–æ–±–∫–∞ –∑–º—ñ–Ω–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É', { 
      phone: phone, 
      cleanPhone: cleanPhone, 
      force: force,
      currentPhone: bonusState.currentPhone,
      isBonusApplied: isBonusPromoCodeApplied(),
      isChecking: bonusState.isCheckingBalance,
      isRegularPromo: isRegularPromoCodeApplied()
    });

    if (isBonusPromoCodeApplied() || bonusState.isCheckingBalance) {
      log('–ü—Ä–æ–ø—É—Å–∫ –æ–±—Ä–æ–±–∫–∏: –±–æ–Ω—É—Å–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –∞–±–æ –π–¥–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞');
      return;
    }

    if (isRegularPromoCodeApplied()) {
      log('–ó–≤–∏—á–∞–π–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ - –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –±–ª–æ–∫ –±–æ–Ω—É—Å—ñ–≤');
      hideBonusBlock();
      return;
    }

    if (isValidPhone(phone)) {
      log('–¢–µ–ª–µ—Ñ–æ–Ω –≤–∞–ª—ñ–¥–Ω–∏–π');
      // –Ø–∫—â–æ —Ü–µ –ø–µ—Ä—à–∏–π –≤–∞–ª—ñ–¥–Ω–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω, –≤–º–∏–∫–∞—î–º–æ –ª–æ–≥—ñ–∫—É
      var bonusBlock = document.querySelector('#bonus-block');
      if (bonusBlock && !bonusBlock.querySelector('#bonus-link').hasAttribute('data-bonus-handlers-attached')) {
        enableBonusElements();
        attachBonusLogic();
      }
      
      if (force || cleanPhone !== bonusState.currentPhone) {
        log('–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–ª–µ—Ñ–æ–Ω—É –∞–±–æ –ø—Ä–∏–º—É—Å–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞');
        resetBonusState();
        updateBonusState({ currentPhone: cleanPhone });
        showBonusBlockWithLoading();
        checkBonusBalance(phone).then(function(bonusBalance) {
          if (findPhoneInput().value.trim().replace(/[\s\-\(\)]/g, '') === cleanPhone) {
            log('–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ –∑–º—ñ–Ω–∏–≤—Å—è –ø—ñ–¥ —á–∞—Å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ - –æ–Ω–æ–≤–ª—é—î–º–æ –±–ª–æ–∫');
            updateBonusBlock(bonusBalance);
          } else {
            log('–¢–µ–ª–µ—Ñ–æ–Ω –∑–º—ñ–Ω–∏–≤—Å—è –ø—ñ–¥ —á–∞—Å –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ - —ñ–≥–Ω–æ—Ä—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç');
          }
        });
      } else {
        log('–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ –∑–º—ñ–Ω–∏–≤—Å—è');
      }
    } else {
      log('–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π - –ø–æ–∫–∞–∑—É—î–º–æ –±–ª–æ–∫ –∑ –ø—ñ–¥–∫–∞–∑–∫–æ—é');
      showBonusBlockWithPrompt();
      resetBonusState();
    }
  }

  function addPhoneEventListeners(telInput) {
    if (!telInput || telInput.hasAttribute('data-bonus-listeners')) {
      log('–°–ª—É—Ö–∞—á—ñ –≤–∂–µ –¥–æ–¥–∞–Ω–æ –∞–±–æ –Ω–µ–º–∞—î –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—É');
      return;
    }
    log('–î–æ–¥–∞–≤–∞–Ω–Ω—è —Å–ª—É—Ö–∞—á—ñ–≤ –ø–æ–¥—ñ–π –¥–æ –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—É', telInput);
    telInput.setAttribute('data-bonus-listeners', 'true');
    var debouncedHandler = debounce(function() { handlePhoneChange(telInput, false); }, 300);
    telInput.addEventListener('input', debouncedHandler);
    telInput.addEventListener('blur', function() { handlePhoneChange(telInput, false); });
    log('–°–ª—É—Ö–∞—á—ñ –ø–æ–¥—ñ–π –¥–æ–¥–∞–Ω–æ');
  }

  function updateBonusBlock(bonusBalance) {
    if (isBonusPromoCodeApplied()) {
      return;
    }
    showBonusBlock();
    var bonusLinkText = document.querySelector('#bonus-block #bonus-link-text');
    if (bonusLinkText) {
      bonusLinkText.innerText = bonusBalance > 0 ? "üéÅ –£ –≤–∞—Å —î " + bonusBalance + " –±–æ–Ω—É—Å—ñ–≤. –•–æ—á–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏?" : "üéÅ –ë–æ–Ω—É—Å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ";
    }
    var bonusAmount = document.querySelector('#bonus-block #bonus-amount');
    if (bonusAmount) {
      bonusAmount.max = bonusBalance > 0 ? bonusBalance : 1;
      bonusAmount.placeholder = bonusBalance > 0 ? "–ú–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ " + bonusBalance + " –±–æ–Ω—É—Å—ñ–≤" : "–ë–æ–Ω—É—Å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ";
      bonusAmount.disabled = bonusBalance === 0;
    }
    if (bonusBalance === 0) {
      showBonusBlock();
      toggleBonusElements(true, '0.5');
    } else {
      enableBonusElements();
      // –î–æ–¥–∞—î–º–æ –ª–æ–≥—ñ–∫—É –≤–∑–∞—î–º–æ–¥—ñ—ó, —è–∫—â–æ –≤–æ–Ω–∞ —â–µ –Ω–µ –±—É–ª–∞ –¥–æ–¥–∞–Ω–∞
      attachBonusLogic();
    }
  }

  function toggleBonusElements(disabled, opacity) {
    var elements = [
      document.querySelector('#bonus-block #bonus-link'),
      document.querySelector('#bonus-block #bonus-amount'),
      document.querySelector('#bonus-block #apply-bonus')
    ];
    elements.forEach(function(el) {
      if (el) {
        el.disabled = disabled;
        el.style.opacity = opacity;
        el.style.pointerEvents = disabled ? 'none' : 'auto';
      }
    });
  }

  function disableBonusElements() {
    toggleBonusElements(true, '0.5');
    var bonusAmount = document.querySelector('#bonus-block #bonus-amount');
    if (bonusAmount) bonusAmount.value = "";
  }

  function enableBonusElements() {
    toggleBonusElements(false, '1');
    var bonusButton = document.querySelector('#bonus-block #apply-bonus');
    if (bonusButton) {
      var btnContent = bonusButton.querySelector('.btn-content') || bonusButton.querySelector('span');
      if (btnContent && btnContent.textContent !== "OK") {
        btnContent.textContent = "OK";
      }
    }
  }

  function removeBonusBlock() {
    updateBonusState({ blockRemovedIntentionally: true });
    var bonusBlock = document.querySelector('#bonus-block');
    if (bonusBlock && bonusBlock.parentNode) {
      bonusBlock.parentNode.removeChild(bonusBlock);
    }
  }

  function attachBonusLogic() {
    var bonusLink = document.querySelector('#bonus-block #bonus-link');
    var bonusForm = document.querySelector('#bonus-block #bonus-form');
    var input = document.querySelector('#bonus-block #bonus-amount');
    var button = document.querySelector('#bonus-block #apply-bonus');
    if (!bonusLink || !bonusForm || !input || !button) {
        return;
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤–∂–µ –¥–æ–¥–∞–Ω—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏
    if (bonusLink.hasAttribute('data-bonus-handlers-attached')) {
        return;
    }
    bonusLink.setAttribute('data-bonus-handlers-attached', 'true');

    var isMobile = isMobileDevice();
    bonusLink.addEventListener("click", function(e) {
      e.preventDefault(); e.stopPropagation();
      bonusLink.parentElement.style.display = "none";
      bonusForm.style.display = isMobile ? "flex" : "block";
      input.focus();
      updateBonusState({ formVisible: true });
    });

    var cancelBtn = document.querySelector('#bonus-block #bonus-cancel');
    if (cancelBtn) {
      cancelBtn.addEventListener("click", function(e) {
        e.preventDefault(); e.stopPropagation();
        bonusForm.style.display = "none";
        bonusLink.parentElement.style.display = "block";
        input.value = "";
        hideError();
        updateBonusState({ formVisible: false, inputValue: "" });
      });
    }

    input.addEventListener('input', function() { updateBonusState({ inputValue: input.value }); });

    var errorDiv = document.querySelector('#bonus-block #bonus-error');
    function showError(message) {
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }
    }
    function hideError() {
      if (errorDiv) errorDiv.style.display = "none";
    }

    function validateBonusAmount(amount) {
      if (isNaN(amount) || amount <= 0) return "–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—É–º—É –±–æ–Ω—É—Å—ñ–≤";
      if (amount > bonusState.balance) return "–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –±–æ–Ω—É—Å—ñ–≤. –î–æ—Å—Ç—É–ø–Ω–æ: " + bonusState.balance;
      var orderTotal = getOrderTotal();
      var maxBonusAmount = Math.floor(orderTotal * 0.5);
      if (amount > maxBonusAmount) return "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ " + maxBonusAmount + " –±–æ–Ω—É—Å—ñ–≤ (50% –≤—ñ–¥ —Å—É–º–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è " + orderTotal + " –≥—Ä–Ω)";
      return null;
    }

    button.addEventListener("click", function(e) {
      e.preventDefault(); e.stopPropagation();
      hideError();
      var amount = parseInt(input.value, 10);
      var validationError = validateBonusAmount(amount);
      if (validationError) {
        showError(validationError);
        return;
      }
      button.disabled = true;
      var btnContent = button.querySelector('.btn-content') || button.querySelector('span');
      if (btnContent) btnContent.textContent = "–ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ...";
      updateBonusState({ promoApplied: true, promoType: 'bonus', formVisible: false, inputValue: "" });
      removeBonusBlock();
      hidePromoCode();
      requestPromoCode(amount)
        .then(applyPromoCodeToForm)
        .catch(function(errorMessage) {
          restoreAfterError(errorMessage);
        });
    });
  }

  function requestPromoCode(amount) {
    log('–ó–∞–ø–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥—É', { amount: amount, url: PROMO_API_URL });
    return fetch(PROMO_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json;charset=UTF-8' },
      body: JSON.stringify({ amount: amount })
    })
    .then(function(response) {
      log('–í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–æ–º–æ–∫–æ–¥—ñ–≤', { status: response.status, ok: response.ok });
      if (response.ok) return response.json();
      return Promise.reject("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º");
    })
    .then(function(data) {
      log('–î–∞–Ω—ñ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–æ–º–æ–∫–æ–¥—ñ–≤', data);
      if (data.success && data.promo_code) {
        log('–ü—Ä–æ–º–æ–∫–æ–¥ –æ—Ç—Ä–∏–º–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ:', data.promo_code);
        return data.promo_code;
      }
      logError('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—Ä–æ–º–æ–∫–æ–¥—É', data);
      return Promise.reject(data.message || "–ü–æ–º–∏–ª–∫–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –±–æ–Ω—É—Å—ñ–≤");
    })
    .catch(function(error) {
      logError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É –ø—Ä–æ–º–æ–∫–æ–¥—É', error);
      return Promise.reject(typeof error === 'string' ? error : "–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ");
    });
  }

  function waitForCertificateTextAndReplace() {
    waitForElementWithCondition(
      CERTIFICATE_SELECTORS.join(','), 
      function(el) { return el.textContent && el.textContent.includes('–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç'); },
      3000
    ).then(instantTextReplace).catch(function() {
    });
  }

  function applyPromoCodeToForm(promoCode) {
    log('–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ø—Ä–æ–º–æ–∫–æ–¥—É –¥–æ —Ñ–æ—Ä–º–∏', { promoCode: promoCode });
    
    function fillAndSubmit(promoInput) {
      log('–ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–º–æ–∫–æ–¥—É');
      var promoButton = isMobileDevice() ? 
        document.querySelector('button.j-coupon-submit:not(#bonus-block button.j-coupon-submit)') : 
        document.querySelector('a.j-coupon-submit:not(#bonus-block a.j-coupon-submit)');
      
      log('–ï–ª–µ–º–µ–Ω—Ç–∏ —Ñ–æ—Ä–º–∏ –ø—Ä–æ–º–æ–∫–æ–¥—É', { promoInput: promoInput, promoButton: promoButton });
      
      if (promoInput && promoButton) {
        promoInput.value = promoCode;
        promoInput.dispatchEvent(new Event('input', { bubbles: true }));
        promoInput.dispatchEvent(new Event('change', { bubbles: true }));
        log('–ü—Ä–æ–º–æ–∫–æ–¥ –≤–≤–µ–¥–µ–Ω–æ, –Ω–∞—Ç–∏—Å–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É');
        promoButton.click();
        setTimeout(function() {
          log('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ª—É—Ö–∞—á–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø—Ä–æ–º–æ–∫–æ–¥—É');
          setupPromoCodeRemovalListener();
          waitForCertificateTextAndReplace();
          checkBonusPromoWithRetry(5, 500);
        }, 500);
      } else {
        logError('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç–∏ —Ñ–æ—Ä–º–∏ –ø—Ä–æ–º–æ–∫–æ–¥—É');
        restoreAfterError("–ù–µ –≤–¥–∞–ª–æ—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥.");
      }
    }
    
    var couponLink = isMobileDevice() ? 
      document.querySelector('button.j-coupon-add:not(#bonus-block button.j-coupon-add):not(#bonus-block button.j-bonus-add-mobile)') : 
      document.querySelector('a.j-coupon-add:not(#bonus-block a.j-coupon-add):not(#bonus-block a.j-bonus-add)');
    
    log('–ü–æ—Å–∏–ª–∞–Ω–Ω—è –∫—É–ø–æ–Ω–∞:', couponLink);
    
    if (couponLink) {
      log('–ù–∞—Ç–∏—Å–∫–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –∫—É–ø–æ–Ω–∞');
      couponLink.click();
    }
    
    waitForElement('.j-coupon-input:not(#bonus-block .j-coupon-input):not(#bonus-block .j-bonus-input)', 2000)
      .then(fillAndSubmit)
      .catch(function(error) {
        logError('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ñ–æ—Ä–º–∏ –ø—Ä–æ–º–æ–∫–æ–¥—É', error);
        restoreAfterError("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ–æ—Ä–º—É –¥–ª—è –≤–≤–æ–¥—É –ø—Ä–æ–º–æ–∫–æ–¥—É.");
      });
  }

  function restoreAfterError(errorMessage) {
    resetBonusState();
    showPromoCode();
    setTimeout(function() {
      initializeCheckoutPage();
      setTimeout(function() {
        var bonusBlock = document.querySelector('#bonus-block');
        if (bonusBlock) {
          var errorDiv = document.querySelector('#bonus-block #bonus-error');
          if (errorDiv) {
            errorDiv.textContent = errorMessage;
            errorDiv.style.display = "block";
          }
          var bonusForm = document.querySelector('#bonus-block #bonus-form');
          var bonusLink = document.querySelector('#bonus-block #bonus-link');
          if (bonusForm && bonusLink) {
            bonusLink.parentElement.style.display = "none";
            bonusForm.style.display = isMobileDevice() ? "flex" : "block";
          }
          var bonusButton = document.querySelector('#bonus-block #apply-bonus');
          if (bonusButton) {
            bonusButton.disabled = false;
            var btnContent = bonusButton.querySelector('.btn-content') || bonusButton.querySelector('span');
            if (btnContent) btnContent.textContent = "OK";
          }
          var phoneInput = findPhoneInput();
          if (phoneInput && !phoneInput.hasAttribute('data-bonus-listeners')) {
            addPhoneEventListeners(phoneInput);
          }
        }
      }, 200);
    }, 300);
  }

  function initializeCheckoutPage() {
    log('–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è');
    
    if (isPromoCodeApplied()) {
      log('–ü—Ä–æ–º–æ–∫–æ–¥ –≤–∂–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ - –Ω–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ —Å–ª—É—Ö–∞—á–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
      setupPromoCodeRemovalListener();
    }
    
    Promise.all([
      waitForElement(PHONE_SELECTORS.join(', '), 5000),
      new Promise(function(resolve) { 
        var containerInfo = findBonusInsertContainer();
        log('–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—è:', containerInfo);
        if (containerInfo) {
          resolve(containerInfo);
        } else {
          log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –æ—á—ñ–∫—É—î–º–æ 1 —Å–µ–∫—É–Ω–¥—É');
          setTimeout(function() { 
            var retryContainer = findBonusInsertContainer();
            log('–ü–æ–≤—Ç–æ—Ä–Ω–∏–π –ø–æ—à—É–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:', retryContainer);
            resolve(retryContainer); 
          }, 1000);
        }
      })
    ]).then(function(results) {
      var phoneInput = results[0];
      var insertInfo = results[1];
      
      log('–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ Promise.all:', { phoneInput: phoneInput, insertInfo: insertInfo });
      
      if (!phoneInput) {
        log('–ü–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø–æ–≤—Ç–æ—Ä–Ω–∞ —Å–ø—Ä–æ–±–∞ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É');
        setTimeout(initializeCheckoutPage, 1000);
        return;
      }
      
      phoneInput = findPhoneInput();
      if (!phoneInput) {
        log('–ü–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –ø–æ—à—É–∫—É');
        return;
      }

      if (isBonusPromoCodeApplied()) {
        log('–ë–æ–Ω—É—Å–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ - –±–ª–æ–∫—É—î–º–æ —Ç–µ–ª–µ—Ñ–æ–Ω —Ç–∞ –≤–∏–¥–∞–ª—è—î–º–æ –±–ª–æ–∫');
        disablePhoneInput();
        if (document.querySelector('#bonus-block')) {
            removeBonusBlock();
        }
        instantTextReplace();
        return;
      }

      log('–î–æ–¥–∞—î–º–æ —Å–ª—É—Ö–∞—á—ñ –¥–æ –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω—É');
      addPhoneEventListeners(phoneInput);

      if (!insertInfo) {
        log('–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –≤—ñ–¥—Å—É—Ç–Ω—è');
        return;
      }
      
      var existingBonusBlock = document.querySelector('#bonus-block');
      if (existingBonusBlock) {
        log('–í–∏–¥–∞–ª—è—î–º–æ —ñ—Å–Ω—É—é—á–∏–π –±–ª–æ–∫ –±–æ–Ω—É—Å—ñ–≤');
        existingBonusBlock.parentNode.removeChild(existingBonusBlock);
      }
      
      updateBonusState({ blockRemovedIntentionally: false });
      log('–°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –±–ª–æ–∫ –±–æ–Ω—É—Å—ñ–≤');
      
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –≤–≤–µ–¥–µ–Ω–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω
      var currentPhoneInput = findPhoneInput();
      var hasValidPhone = currentPhoneInput && currentPhoneInput.value && currentPhoneInput.value.trim() !== '' && isValidPhone(currentPhoneInput.value);
      
      // –°—Ç–≤–æ—Ä—é—î–º–æ –±–ª–æ–∫ –∑ –ø—ñ–¥–∫–∞–∑–∫–æ—é —è–∫—â–æ –Ω–µ–º–∞—î –≤–∞–ª—ñ–¥–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É
      createBonusBlock(insertInfo.el, bonusState.balance || 0, insertInfo.insertMode || 'after', insertInfo.type, !hasValidPhone);
      
      if (hasValidPhone) {
        log('–Ñ –≤–∞–ª—ñ–¥–Ω–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É, –æ–±—Ä–æ–±–ª—è—î–º–æ –∑–º—ñ–Ω—É');
        setTimeout(function() { 
          if (currentPhoneInput) handlePhoneChange(currentPhoneInput, true); 
        }, 50);
      } else {
        log('–ù–µ–º–∞—î –≤–∞–ª—ñ–¥–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—É, –ø–æ–∫–∞–∑—É—î–º–æ –±–ª–æ–∫ –∑ –ø—ñ–¥–∫–∞–∑–∫–æ—é');
        showBonusBlockWithPrompt();
      }
    }).catch(function(error) {
      logError('–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è', error);
    });
  }

  function initializeCartObserver() {
    var bonusBlockRestoreTimeout;
    var lastBonusBlockCheck = 0;
    var observer = new MutationObserver(function(mutations) {
      var shouldCheckBonusBlock = false;
      var shouldReplaceText = false;
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
          mutation.removedNodes.forEach(function(node) {
            if (node.nodeType === 1 && (node.id === 'bonus-block' || (node.querySelector && node.querySelector('#bonus-block')))) {
              if (!bonusState.blockRemovedIntentionally) {
                shouldCheckBonusBlock = true;
              }
            }
          });
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) {
              var elementsToScan = [node].concat(Array.from(node.querySelectorAll ? node.querySelectorAll(CERTIFICATE_SELECTORS.join(',')) : []));
              elementsToScan.forEach(function(el) {
                if (el.textContent && el.textContent.includes('–ü–æ–¥–∞—Ä—É–Ω–∫–æ–≤–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç') && !el.closest('#bonus-block')) {
                  shouldReplaceText = true;
                }
              });
              if (node.matches && node.matches('.j-coupon-remove') || (node.querySelector && node.querySelector('.j-coupon-remove'))) {
                setTimeout(setupPromoCodeRemovalListener, 100);
              }
              if (node.matches && (node.matches('.order-details') || node.matches('.order-details__block') || node.matches('.order-details-i'))) {
                shouldCheckBonusBlock = true;
              }
            }
          });
        }
      });
      if (shouldReplaceText) {
        setTimeout(function() {
            instantTextReplace();
            ensurePhoneLockState();
        }, 50);
      }
      if (shouldCheckBonusBlock && window.location.href.includes('/checkout/')) {
        var now = Date.now();
        if (now - lastBonusBlockCheck > 1000) {
          lastBonusBlockCheck = now;
          clearTimeout(bonusBlockRestoreTimeout);
          bonusBlockRestoreTimeout = setTimeout(function() {
            if (!document.querySelector('#bonus-block') && !isBonusPromoCodeApplied() && !bonusState.blockRemovedIntentionally) {
              initializeCheckoutPage();
            }
          }, 500);
        }
      }
    });
    observer.observe(document.documentElement, { childList: true, subtree: true });
  }

  function initBonusSystem() {
    log('–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–∏—Å—Ç–µ–º–∏ –±–æ–Ω—É—Å—ñ–≤');
    log('–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω:', bonusState);
    
    if (isBonusPromoCodeApplied()) {
        log('–ë–æ–Ω—É—Å–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó');
        instantTextReplace();
        ensurePhoneLockState();
    }

    log('–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á–∞ –∑–∞ –∑–º—ñ–Ω–∞–º–∏');
    initializeCartObserver();

    var isCheckoutPage = window.location.href.includes('/checkout/');
    log('–¢–∏–ø —Å—Ç–æ—Ä—ñ–Ω–∫–∏:', { isCheckoutPage: isCheckoutPage, url: window.location.href });
    
    if (isCheckoutPage) {
      log('–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è');
      initializeCheckoutPage();
    } else {
      log('–ù–µ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è - –±–∞–∑–æ–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è');
      if (isPromoCodeApplied()) {
        log('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ª—É—Ö–∞—á–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø—Ä–æ–º–æ–∫–æ–¥—É');
        setupPromoCodeRemovalListener();
      }
      waitForElement(PHONE_SELECTORS.join(', '), 3000)
        .then(function(phoneInput) {
          log('–ó–Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É, –¥–æ–¥–∞—î–º–æ —Å–ª—É—Ö–∞—á—ñ');
          addPhoneEventListeners(phoneInput);
        })
        .catch(function() {
          log('–ü–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        });
    }
  }

  log('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ–≥–æ —Å—Ç–∞–Ω—É');
  loadBonusState();
  log('–ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º–∏ –±–æ–Ω—É—Å—ñ–≤');
  initBonusSystem();

})();
</script>
