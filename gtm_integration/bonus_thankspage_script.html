<script>
(function() {
  'use strict';
  
  var BONUS_ACCRUAL_API_URL = "https://duu98ifeda.execute-api.eu-north-1.amazonaws.com/prod/bonus-accrual";
  var BONUS_PERCENTAGE = 0.10;
  
  function getOrderNumber() {
    var invoiceRows = document.querySelectorAll('.invoice__item');
    
    for (var i = 0; i < invoiceRows.length; i++) {
      var nameCell = invoiceRows[i].querySelector('.invoice__name'); 
      var valueCell = invoiceRows[i].querySelector('.invoice__value');
      
      if (nameCell && valueCell) {
        var nameText = nameCell.textContent || nameCell.innerText;
        var valueText = valueCell.textContent || valueCell.innerText;
        
        if (nameText.toLowerCase().includes('–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è') || nameText.toLowerCase().includes('–∑–∞–∫–∞–∑')) {
          var orderMatch = valueText.match(/(\d+)/);
          if (orderMatch) {
            return orderMatch[1];
          }
        }
      }
    }
    
    var orderHeaders = document.querySelectorAll('.h2');
    
    for (var i = 0; i < orderHeaders.length; i++) {
      var text = orderHeaders[i].textContent || orderHeaders[i].innerText;
      var match = text.match(/–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è\s*‚Ññ(\d+)/i);
      if (match) {
        return match[1];
      }
    }
    
    var orderElements = document.querySelectorAll('[id*="order"], [class*="order"]');
    
    for (var i = 0; i < orderElements.length; i++) {
      var text = orderElements[i].textContent || orderElements[i].innerText;
      var match = text.match(/‚Ññ(\d+)/);
      if (match) {
        return match[1];
      }
    }
    
    return null;
  }
  
  function getOrderTotal() {
    var mobileTotal = document.querySelector('.order-details__total');
    
    if (mobileTotal) {
      var text = mobileTotal.textContent || mobileTotal.innerText;
      var cleanText = text.replace(/[^\d.,]/g, '').replace(',', '.');
      var amount = parseFloat(cleanText);
      
      if (!isNaN(amount) && amount > 0) {
        return amount;
      }
    }
    
    var totalSelectors = [
      '.order-summary-b',
      '.order-total',
      '.checkout-total',
      '.summary-total'
    ];
    
    for (var i = 0; i < totalSelectors.length; i++) {
      var selector = totalSelectors[i];
      var element = document.querySelector(selector);
      
      if (element) {
        var text = element.textContent || element.innerText;
        var cleanText = text.replace(/[^\d.,]/g, '').replace(',', '.');
        var amount = parseFloat(cleanText);
        
        if (!isNaN(amount) && amount > 0) {
          return amount;
        }
      }
    }
    
    return null;
  }
  
  function getCustomerData() {
    var customerData = {};
    
    var invoiceItems = document.querySelectorAll('.invoice__item');
    
    for (var i = 0; i < invoiceItems.length; i++) {
      var nameElement = invoiceItems[i].querySelector('.invoice__name');
      var valueElement = invoiceItems[i].querySelector('.invoice__value');
      
      if (nameElement && valueElement) {
        var nameText = nameElement.textContent || nameElement.innerText;
        var valueText = valueElement.textContent || valueElement.innerText;
        
        nameText = nameText.toLowerCase();
        if (nameText.includes("—ñ–º'—è") || nameText.includes("–ø—Ä—ñ–∑–≤–∏—â–µ") || nameText.includes("–ø–æ–∫—É–ø–µ—Ü—å")) {
          customerData.name = valueText.trim();
        } else if (nameText.includes("–µ-–ø–æ—à—Ç–∞") || nameText.includes("email") || nameText.includes("–ø–æ—à—Ç–∞")) {
          customerData.email = valueText.trim();
        } else if (nameText.includes("—Ç–µ–ª–µ—Ñ–æ–Ω") || nameText.includes("—Ç–µ–ª.")) {
          customerData.phone = valueText.trim();
        }
      }
    }
    
    if (!customerData.name && !customerData.email && !customerData.phone) {
      var customerBlock = document.querySelector('#order-customer-data');
      
      if (customerBlock) {
        var items = customerBlock.querySelectorAll('dt.check-h');
        
        for (var i = 0; i < items.length; i++) {
          var label = items[i].textContent || items[i].innerText;
          var valueElement = items[i].nextElementSibling;
          
          if (valueElement && valueElement.classList.contains('check-b')) {
            var value = valueElement.textContent || valueElement.innerText;
            
            if (label.includes("–Ü–º'—è") || label.includes("–ø—Ä—ñ–∑–≤–∏—â–µ")) {
              customerData.name = value.trim();
            } else if (label.includes("–ï-–ø–æ—à—Ç–∞") || label.includes("email")) {
              customerData.email = value.trim();
            } else if (label.includes("–¢–µ–ª–µ—Ñ–æ–Ω")) {
              customerData.phone = value.trim();
            }
          }
        }
      }
    }
    
    return customerData;
  }
  
  function getUsedBonusAmount() {
    // –°–µ–ª–µ–∫—Ç–æ—Ä–∏ –¥–ª—è –ø–æ—à—É–∫—É –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏—Ö –±–æ–Ω—É—Å—ñ–≤
    var bonusSelectors = [
      '.order-details__cost-value', // –ú–æ–±—ñ–ª—å–Ω–∞ –≤–µ—Ä—Å—ñ—è
      '.order-details-b'            // –î–µ—Å–∫—Ç–æ–ø–Ω–∞ –≤–µ—Ä—Å—ñ—è
    ];
    
    for (var i = 0; i < bonusSelectors.length; i++) {
      var elements = document.querySelectorAll(bonusSelectors[i]);
      
      for (var j = 0; j < elements.length; j++) {
        var element = elements[j];
        var text = element.textContent || element.innerText;
        
        // –®—É–∫–∞—î–º–æ —Ç–µ–∫—Å—Ç —â–æ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ –º—ñ–Ω—É—Å–∞ (–∑–Ω–∞–∫ —Å–ø–∏—Å–∞–Ω–Ω—è)
        if (text && text.trim().startsWith('‚Äì') || text.trim().startsWith('-')) {
          // –í–∏—Ç—è–≥—É—î–º–æ —á–∏—Å–ª–æ –∑ —Ç–µ–∫—Å—Ç—É
          var bonusMatch = text.match(/[‚Äì-]\s*(\d+(?:[.,]\d+)?)/);
          if (bonusMatch) {
            var usedAmount = parseFloat(bonusMatch[1].replace(',', '.'));
            if (!isNaN(usedAmount) && usedAmount > 0) {
              return usedAmount;
            }
          }
        }
      }
    }
    
    return 0;
  }
  
  function processBonusOperation(orderData) {
    return new Promise(function(resolve, reject) {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', BONUS_ACCRUAL_API_URL, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              var response = JSON.parse(xhr.responseText);
              resolve(response);
            } catch (e) {
              reject(new Error('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ'));
            }
          } else {
            reject(new Error('–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + xhr.status));
          }
        }
      };
      
      xhr.onerror = function() {
        reject(new Error('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ'));
      };
      
      xhr.send(JSON.stringify(orderData));
    });
  }
  
  function showBonusNotification(operationData) {
    var bonusAmount = operationData.bonusAmount || 0;
    var usedAmount = operationData.usedBonusAmount || 0;
    var isCombo = bonusAmount > 0 && usedAmount > 0;
    var isOnlyDeduction = usedAmount > 0 && bonusAmount === 0;
    var isOnlyAccrual = bonusAmount > 0 && usedAmount === 0;
    
    var notification = document.createElement('div');
    notification.style.cssText = 
      'background: linear-gradient(135deg, #16a085, #1abc9c);' +
      'color: white;' +
      'padding: 15px;' +
      'margin: 15px auto;' +
      'border-radius: 8px;' +
      'text-align: center;' +
      'font-size: 14px;' +
      'box-shadow: 0 4px 12px rgba(22, 160, 133, 0.3);' +
      'animation: slideIn 0.5s ease-out;' +
      'max-width: 100%;' +
      'box-sizing: border-box;' +
      'position: relative;' +
      'z-index: 1000;';
    
    var titleText = '';
    var detailsText = '';
    
    if (isCombo) {
      titleText = 'üéÅ –û–ø–µ—Ä–∞—Ü—ñ—ó –∑ –±–æ–Ω—É—Å–∞–º–∏ –≤–∏–∫–æ–Ω–∞–Ω—ñ!';
      detailsText = 
        '<div style="font-size: 15px; font-weight: bold; margin-bottom: 8px;">' +
          '–°–ø–∏—Å–∞–Ω–æ: <strong>-' + usedAmount + '</strong> –±–æ–Ω—É—Å—ñ–≤ | ' +
          '–ù–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ: <strong>+' + bonusAmount + '</strong> –±–æ–Ω—É—Å—ñ–≤' +
        '</div>' +
        '<div style="font-size: 13px; opacity: 0.9;">' +
          '–ü—ñ–¥—Å—É–º–æ–∫: ' + (bonusAmount - usedAmount > 0 ? '+' : '') + (bonusAmount - usedAmount) + ' –±–æ–Ω—É—Å—ñ–≤ –¥–æ –±–∞–ª–∞–Ω—Å—É' +
        '</div>';
    } else if (isOnlyDeduction) {
      titleText = 'üí∏ –ë–æ–Ω—É—Å–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ!';
      detailsText = 
        '<div style="font-size: 15px; font-weight: bold;">–°–ø–∏—Å–∞–Ω–æ <strong>' + usedAmount + '</strong> –±–æ–Ω—É—Å—ñ–≤</div>' +
        '<div style="font-size: 12px; margin-top: 8px; opacity: 0.9;">' +
          '–î—è–∫—É—î–º–æ –∑–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –±–æ–Ω—É—Å–Ω–æ—ó –ø—Ä–æ–≥—Ä–∞–º–∏!' +
        '</div>';
    } else if (isOnlyAccrual) {
      titleText = 'üéÅ –í—ñ—Ç–∞—î–º–æ! –í–∞–º –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ –±–æ–Ω—É—Å–∏!';
      detailsText = 
        '<div style="font-size: 15px; font-weight: bold;">–ó–∞ —Ü–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ <strong>' + bonusAmount + '</strong> –±–æ–Ω—É—Å—ñ–≤</div>' +
        '<div style="font-size: 12px; margin-top: 8px; opacity: 0.9;">' +
          '–ë–æ–Ω—É—Å–∏ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ' +
        '</div>';
    }
    
    notification.innerHTML = 
      '<div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px; flex-wrap: wrap;">' +
        '<span style="font-size: 20px; margin-right: 8px;">' + (isOnlyDeduction ? 'üí∏' : 'üéÅ') + '</span>' +
        '<strong style="font-size: 16px;">' + titleText + '</strong>' +
      '</div>' +
      detailsText;
    
    var style = document.createElement('style');
    style.textContent = 
      '@keyframes slideIn {' +
        'from { opacity: 0; transform: translateY(-20px); }' +
        'to { opacity: 1; transform: translateY(0); }' +
      '}' +
      '@media (max-width: 768px) {' +
        'div[style*="background: linear-gradient(135deg, #16a085, #1abc9c)"] {' +
          'margin: 10px !important;' +
          'padding: 12px !important;' +
          'font-size: 13px !important;' +
        '}' +
      '}';
    document.head.appendChild(style);
    
    var insertionPoint = null;
    
    var —Åontainers = [
      '.invoice',
      '#order-customer-data'
    ];
    
    for (var i = 0; i < —Åontainers.length; i++) {
      var container = document.querySelector(—Åontainers[i]);
      if (container) {
        insertionPoint = container;
        break;
      }
    }
    
    if (insertionPoint) {
      insertionPoint.parentNode.insertBefore(notification, insertionPoint.nextSibling);
    } else {
      document.body.appendChild(notification);
    }
  }
  
  function isAlreadyProcessed(orderId) {
    try {
      var processed = localStorage.getItem('bonusProcessed_' + orderId);
      return processed === 'true';
    } catch (e) {
      return false;
    }
  }
  
  function markAsProcessed(orderId) {
    try {
      localStorage.setItem('bonusProcessed_' + orderId, 'true');
    } catch (e) {
    }
  }
  
  function shouldShowNotification(orderId) {
    // –ó–∞–≤–∂–¥–∏ –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –ø–æ–¥—è–∫–∏
    return true;
  }
  
  function getStoredBonusData(orderId) {
    try {
      var storedData = localStorage.getItem('bonusData_' + orderId);
      return storedData ? JSON.parse(storedData) : null;
    } catch (e) {
      return null;
    }
  }
  
  function storeBonusData(orderId, bonusData) {
    try {
      localStorage.setItem('bonusData_' + orderId, JSON.stringify(bonusData));
    } catch (e) {
    }
  }

  function processBonusAccrual() {
    var currentUrl = window.location.href;
    var isCheckoutCompletePage = currentUrl.includes('checkout/complete');
    
    if (!isCheckoutCompletePage) {
      return;
    }
    
    var orderId = getOrderNumber();
    var orderTotal = getOrderTotal();
    var customerData = getCustomerData();
    var usedBonusAmount = getUsedBonusAmount();
    
    if (!orderId) {
      return;
    }
    
    if (!orderTotal) {
      return;
    }
    
    if (!customerData.phone && !customerData.email) {
      return;
    }
    
    var bonusAmount = Math.floor(orderTotal * BONUS_PERCENTAGE);
    
    var hasAccrual = bonusAmount > 0;
    var hasDeduction = usedBonusAmount > 0;
    
    if (!hasAccrual && !hasDeduction) {
      return;
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –¥–∞–Ω—ñ –ø—Ä–æ –±–æ–Ω—É—Å–∏
    var storedBonusData = getStoredBonusData(orderId);
    
    if (storedBonusData) {
      // –Ø–∫—â–æ —î –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –¥–∞–Ω—ñ, –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ –Ω–∏—Ö
      showBonusNotification(storedBonusData);
      return;
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –æ–ø–µ—Ä–∞—Ü—ñ—è –≤–∂–µ –±—É–ª–∞ –≤–∏–∫–æ–Ω–∞–Ω–∞
    if (isAlreadyProcessed(orderId)) {
      // –Ø–∫—â–æ –æ–ø–µ—Ä–∞—Ü—ñ—è –±—É–ª–∞ –≤–∏–∫–æ–Ω–∞–Ω–∞, –∞–ª–µ –Ω–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –¥–∞–Ω–∏—Ö –ø—Ä–æ –ø–æ–∫–∞–∑,
      // –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ—Ç–æ—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö
      var notificationData = {
        bonusAmount: hasAccrual ? bonusAmount : 0,
        usedBonusAmount: hasDeduction ? usedBonusAmount : 0
      };
      showBonusNotification(notificationData);
      storeBonusData(orderId, notificationData);
      return;
    }
    
    var requestData = {
      orderId: orderId,
      orderTotal: orderTotal,
      customer: {
        name: customerData.name || '',
        phone: customerData.phone || '',
        email: customerData.email || ''
      },
      timestamp: new Date().toISOString(),
      source: 'thank_you_page'
    };
    
    if (hasAccrual) {
      requestData.bonusAmount = bonusAmount;
    }
    
    if (hasDeduction) {
      requestData.usedBonusAmount = usedBonusAmount;
    }
    
    processBonusOperation(requestData)
      .then(function(response) {
        markAsProcessed(orderId);
        
        var notificationData = {
          bonusAmount: hasAccrual ? bonusAmount : 0,
          usedBonusAmount: hasDeduction ? usedBonusAmount : 0
        };
        
        storeBonusData(orderId, notificationData);
        showBonusNotification(notificationData);
      })
      .catch(function(error) {
        // –ù–∞–≤—ñ—Ç—å —É –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏ –ø–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —Ç–µ, —â–æ –º–∞–ª–æ –± –±—É—Ç–∏
        var notificationData = {
          bonusAmount: hasAccrual ? bonusAmount : 0,
          usedBonusAmount: hasDeduction ? usedBonusAmount : 0
        };
        
        storeBonusData(orderId, notificationData);
        showBonusNotification(notificationData);
      });
  }
  
  var currentUrl = window.location.href;
  var isValidPage = currentUrl.includes('checkout/complete');
  
  if (!isValidPage) {
    return;
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      processBonusAccrual(); // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É
    });
  } else {
    processBonusAccrual(); // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É
  }
  
})();
</script>
