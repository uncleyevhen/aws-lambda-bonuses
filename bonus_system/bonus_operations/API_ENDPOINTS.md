# üéØ Bonus Operations API Gateway

–°–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π API Gateway –¥–ª—è Lambda —Ñ—É–Ω–∫—Ü—ñ—ó `bonus-operations` –∑ —É—Å—ñ–º–∞ —ó—ó –µ–Ω–¥–ø–æ—ñ–Ω—Ç–∞–º–∏.

## üìã –ï–Ω–¥–ø–æ—ñ–Ω—Ç–∏

### 1. POST /order-complete
**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –û–±—Ä–æ–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –±–æ–Ω—É—Å—ñ–≤  
**–î–∂–µ—Ä–µ–ª–æ**: Webhook –≤—ñ–¥ KeyCRM –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å—Ç–∞—Ç—É—Å—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ "–≤–∏–∫–æ–Ω–∞–Ω–æ"

```json
{
  "event": "order.change_order_status",
  "context": {
    "id": "12345",
    "client_id": "67890",
    "grand_total": 1000,
    "status_name": "completed",
    "discount_amount": 50
  }
}
```

**–õ–æ–≥—ñ–∫–∞**:
- –°–ø–∏—Å—É—î –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –±–æ–Ω—É—Å–∏ –∑ —Ä–µ–∑–µ—Ä–≤—É
- –ù–∞—Ä–∞—Ö–æ–≤—É—î –Ω–æ–≤—ñ –±–æ–Ω—É—Å–∏ (10% –≤—ñ–¥ —Å—É–º–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è)
- –õ–æ–≥—É—î —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –≤ —ñ—Å—Ç–æ—Ä—ñ—é –±–æ–Ω—É—Å—ñ–≤

### 2. POST /order-cancel  
**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –°–∫–∞—Å—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –±–æ–Ω—É—Å—ñ–≤ –∑ —Ä–µ–∑–µ—Ä–≤—É  
**–î–∂–µ—Ä–µ–ª–æ**: –ü—Ä—è–º–∏–π API –≤–∏–∫–ª–∏–∫ –∞–±–æ webhook –ø—Ä–∏ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è

```json
{
  "order_id": "12345",
  "phone": "380123456789",
  "used_bonus_amount": 50
}
```

**–õ–æ–≥—ñ–∫–∞**:
- –®—É–∫–∞—î –≤ —ñ—Å—Ç–æ—Ä—ñ—ó –±–æ–Ω—É—Å—ñ–≤ —Å—É–º—É —Ä–µ–∑–µ—Ä–≤—É –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
- –ü–æ–≤–µ—Ä—Ç–∞—î –∑–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω—ñ –±–æ–Ω—É—Å–∏ –¥–æ –∞–∫—Ç–∏–≤–Ω–∏—Ö
- –ù–ï –Ω–∞—Ä–∞—Ö–æ–≤—É—î –Ω–æ–≤—ñ –±–æ–Ω—É—Å–∏

### 3. POST /order-reserve
**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –†–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è –±–æ–Ω—É—Å—ñ–≤ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è  
**–î–∂–µ—Ä–µ–ª–æ**: Webhook –≤—ñ–¥ KeyCRM –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ –ø—Ä–æ–º–æ–∫–æ–¥–æ–º

```json
{
  "event": "order.create",
  "context": {
    "id": "12345",
    "client_id": "67890",
    "grand_total": 1000,
    "status_name": "new",
    "discount_amount": 100,
    "promo_code": "BONUS100"
  }
}
```

**–õ–æ–≥—ñ–∫–∞**:
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—É —Ç–∞ –∑–Ω–∏–∂–∫–∏
- –†–µ–∑–µ—Ä–≤—É—î –±–æ–Ω—É—Å–∏ –∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å—É –∫–ª—ñ—î–Ω—Ç–∞
- –ó–º–µ–Ω—à—É—î –∞–∫—Ç–∏–≤–Ω—ñ –±–æ–Ω—É—Å–∏, –∑–±—ñ–ª—å—à—É—î –∑–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω—ñ

### 4. POST /lead-reserve
**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –ú–∞–Ω—É–∞–ª—å–Ω–µ —Ä–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è –±–æ–Ω—É—Å—ñ–≤ —á–µ—Ä–µ–∑ –ª—ñ–¥–∏  
**–î–∂–µ—Ä–µ–ª–æ**: Webhook –≤—ñ–¥ KeyCRM –ø—Ä–∏ —Ä–æ–±–æ—Ç—ñ –∑ –ª—ñ–¥–∞–º–∏

```json
{
  "event": "lead.change_status",
  "context": {
    "id": "54321",
    "status": "active",
    "custom_fields": [
      {
        "uuid": "LD_1035",
        "value": "100"
      }
    ]
  }
}
```

**–õ–æ–≥—ñ–∫–∞**:
- –ü–æ–∫–∏ —â–æ –≤ —Ä–µ–∂–∏–º—ñ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∏
- –ü–ª–∞–Ω—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ä–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è –±–æ–Ω—É—Å—ñ–≤ —á–µ—Ä–µ–∑ –ª—ñ–¥–∏

### 5. POST /test-log
**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –¢–µ—Å—Ç–æ–≤–∏–π –µ–Ω–¥–ø–æ—ñ–Ω—Ç –¥–ª—è –ª–æ–≥—É–≤–∞–Ω–Ω—è webhook'—ñ–≤  
**–î–∂–µ—Ä–µ–ª–æ**: –¢–µ—Å—Ç–æ–≤—ñ –∑–∞–ø–∏—Ç–∏, –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è

```json
{
  "test": "–¢–µ—Å—Ç–æ–≤–∏–π –∑–∞–ø–∏—Ç",
  "timestamp": "2025-07-30T12:00:00Z"
}
```

**–õ–æ–≥—ñ–∫–∞**:
- –ü—Ä–æ—Å—Ç–æ –ª–æ–≥—É—î –æ—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ
- –ö–æ—Ä–∏—Å–Ω–æ –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è webhook'—ñ–≤

## üöÄ –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞–¥–∞–Ω–Ω—è –ø—Ä–∞–≤ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
```bash
chmod +x setup_api_gateway.sh
```

### 2. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è API Gateway
```bash
./setup_api_gateway.sh setup
```

### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö –µ–Ω–¥–ø–æ—ñ–Ω—Ç—ñ–≤
```bash
./setup_api_gateway.sh info
```

### 4. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è API
```bash
./setup_api_gateway.sh test
```

## üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è KeyCRM Webhooks

–ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è API Gateway –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ webhook'–∏ –≤ KeyCRM:

### Webhook –¥–ª—è –∑–∞–º–æ–≤–ª–µ–Ω—å:
- **URL**: `https://[api-id].execute-api.eu-north-1.amazonaws.com/order-complete`
- **–°–æ–±—ã—Ç–∏—è**: `order.change_order_status`
- **–°—Ç–∞—Ç—É—Å–∏**: completed, cancelled, delivered

### Webhook –¥–ª—è —Ä–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è:
- **URL**: `https://[api-id].execute-api.eu-north-1.amazonaws.com/order-reserve`  
- **–°–æ–±—ã—Ç–∏—è**: `order.create`, `order.change_order_status`
- **–°—Ç–∞—Ç—É—Å–∏**: new, pending

### Webhook –¥–ª—è –ª—ñ–¥—ñ–≤:
- **URL**: `https://[api-id].execute-api.eu-north-1.amazonaws.com/lead-reserve`
- **–°–æ–±—ã—Ç–∏—è**: `lead.change_status`, `lead.update`

## üìä –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –ª–æ–≥–∏

### CloudWatch –ª–æ–≥–∏
```bash
# –ü–µ—Ä–µ–≥–ª—è–¥ –ª–æ–≥—ñ–≤ Lambda —Ñ—É–Ω–∫—Ü—ñ—ó
aws logs filter-log-events \
  --log-group-name /aws/lambda/bonus-operations \
  --start-time $(date -d '1 hour ago' +%s)000 \
  --region eu-north-1
```

### API Gateway –º–µ—Ç—Ä–∏–∫–∏
```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∏–∫–ª–∏–∫—ñ–≤ API
aws apigatewayv2 get-apis --region eu-north-1 \
  --query 'Items[?Name==`bonus-operations-api`]'
```

## üîç –ù–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É Lambda
```bash
aws lambda get-function --function-name bonus-operations --region eu-north-1
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ—É—Ç—ñ–≤ API
```bash
# –û—Ç—Ä–∏–º–∞–π—Ç–µ API ID
API_ID=$(aws apigatewayv2 get-apis --region eu-north-1 \
  --query 'Items[?Name==`bonus-operations-api`].ApiId' --output text)

# –ü–µ—Ä–µ–≥–ª—è–¥–Ω—ñ—Ç—å —Ä–æ—É—Ç–∏
aws apigatewayv2 get-routes --api-id $API_ID --region eu-north-1
```

### –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –æ–∫—Ä–µ–º–∏—Ö –µ–Ω–¥–ø–æ—ñ–Ω—Ç—ñ–≤
```bash
# –ë–∞–∑–æ–≤–∏–π URL API
BASE_URL="https://[api-id].execute-api.eu-north-1.amazonaws.com"

# –¢–µ—Å—Ç –ª–æ–≥—É–≤–∞–Ω–Ω—è
curl -X POST "$BASE_URL/test-log" \
  -H "Content-Type: application/json" \
  -d '{"test": "connection check"}'

# –¢–µ—Å—Ç —Ä–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è (—Ç–µ—Å—Ç–æ–≤—ñ –¥–∞–Ω—ñ)
curl -X POST "$BASE_URL/order-reserve" \
  -H "Content-Type: application/json" \
  -d '{
    "event": "order.create",
    "context": {
      "id": "test-123",
      "client_id": "test-client",
      "grand_total": 500,
      "status_name": "new",
      "discount_amount": 50,
      "promo_code": "TEST50"
    }
  }'
```

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤—ñ –∑–∞—É–≤–∞–∂–µ–Ω–Ω—è

1. **CORS**: API –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –¥–ª—è –ø—Ä–∏–π–æ–º—É –∑–∞–ø–∏—Ç—ñ–≤ –∑ –±—É–¥—å-—è–∫–∏—Ö –¥–æ–º–µ–Ω—ñ–≤
2. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è**: –ù–∞ –¥–∞–Ω–Ω–∏–π –º–æ–º–µ–Ω—Ç –≤—ñ–¥—Å—É—Ç–Ω—è (webhook'–∏ –≤—ñ–¥ KeyCRM)
3. **–õ—ñ–º—ñ—Ç–∏**: –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º AWS –ª—ñ–º—ñ—Ç—É—î –¥–æ 10,000 –∑–∞–ø–∏—Ç—ñ–≤/—Å–µ–∫
4. **–¢–∞–π–º–∞—É—Ç–∏**: Lambda —Ñ—É–Ω–∫—Ü—ñ—è –º–∞—î —Ç–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥

## üÜò –ü—ñ–¥—Ç—Ä–∏–º–∫–∞

–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:
1. –°—Ç–∞—Ç—É—Å Lambda —Ñ—É–Ω–∫—Ü—ñ—ó –≤ AWS –∫–æ–Ω—Å–æ–ª—ñ
2. CloudWatch –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
3. –ü—Ä–∞–≤–∏–ª—å–Ω—ñ—Å—Ç—å payload'—ñ–≤ webhook'—ñ–≤
4. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–æ–ª–µ–π —Ç–∞ –¥–æ–∑–≤–æ–ª—ñ–≤ AWS

---

üéâ **API Gateway –≥–æ—Ç–æ–≤–∏–π –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –≤—Å—ñ—Ö –±–æ–Ω—É—Å–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π!**
